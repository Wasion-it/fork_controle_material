name: Pipeline CI/CD

on:
  push:
    branches:
      - main

env:
  DEPLOY_HOST: 10.10.1.222
  DEPLOY_USER: root
  DEPLOY_PORT: 22
  PROJECT_DIR: /home/admin-ti/controle_material
  DOCKER_REGISTRY: 10.10.1.222:5000
  MYSQL_DATABASE: controle_material
  STACK_NAME: controle_estoque

jobs:
  build:
    name: Build and Push Images
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build backend image
        run: |
          docker build -t ${{ env.DOCKER_REGISTRY }}/controle_material-backend:latest \
                       -t ${{ env.DOCKER_REGISTRY }}/controle_material-backend:${{ github.sha }} \
                       ./backend
          docker save -o backend-image.tar \
                      ${{ env.DOCKER_REGISTRY }}/controle_material-backend:latest \
                      ${{ env.DOCKER_REGISTRY }}/controle_material-backend:${{ github.sha }}

      - name: Build frontend image
        run: |
          docker build -t ${{ env.DOCKER_REGISTRY }}/controle_material-frontend:latest \
                       -t ${{ env.DOCKER_REGISTRY }}/controle_material-frontend:${{ github.sha }} \
                       ./frontend
          docker save -o frontend-image.tar \
                      ${{ env.DOCKER_REGISTRY }}/controle_material-frontend:latest \
                      ${{ env.DOCKER_REGISTRY }}/controle_material-frontend:${{ github.sha }}

      - name: Upload backend image artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-image
          path: backend-image.tar
          retention-days: 1

      - name: Upload frontend image artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-image
          path: frontend-image.tar
          retention-days: 1

  deploy:
    name: Deploy to Swarm
    needs: build
    runs-on: self-hosted  # Runner no mesmo servidor do Swarm
    steps:
      - name: Download backend image
        uses: actions/download-artifact@v4
        with:
          name: backend-image

      - name: Download frontend image
        uses: actions/download-artifact@v4
        with:
          name: frontend-image

      - name: Deploy Locally
        env:
          DOCKER_REGISTRY: ${{ env.DOCKER_REGISTRY }}
          STACK_NAME: ${{ env.STACK_NAME }}
        run: |
          echo "üì¶ Loading backend image..."
          docker load -i backend-image.tar

          echo "üì¶ Loading frontend image..."
          docker load -i frontend-image.tar

          echo "üîÑ Updating Swarm services (zero downtime)..."
          
          # Atualizar backend com rolling update
          docker service update \
            --image ${{ env.DOCKER_REGISTRY }}/controle_material-backend:latest \
            --update-parallelism 1 \
            --update-delay 10s \
            --update-order start-first \
            ${{ env.STACK_NAME }}_backend
          
          # Atualizar frontend com rolling update
          docker service update \
            --image ${{ env.DOCKER_REGISTRY }}/controle_material-frontend:latest \
            --update-parallelism 1 \
            --update-delay 10s \
            --update-order start-first \
            ${{ env.STACK_NAME }}_frontend

          echo "üßπ Cleaning up tar files..."
          rm -f backend-image.tar frontend-image.tar

          echo "‚è≥ Waiting for rollout to complete..."
          sleep 15

          echo "‚úÖ Service status:"
          docker service ls | grep ${{ env.STACK_NAME }}
          echo ""
          echo "üìä Backend replicas:"
          docker service ps ${{ env.STACK_NAME }}_backend --filter "desired-state=running" --format "table {{.Name}}\t{{.CurrentState}}\t{{.Error}}" | head -n 5
          echo ""
          echo "üìä Frontend replicas:"
          docker service ps ${{ env.STACK_NAME }}_frontend --filter "desired-state=running" --format "table {{.Name}}\t{{.CurrentState}}\t{{.Error}}" | head -n 5

          # Verificar se h√° erros
          BACKEND_ERRORS=$(docker service ps ${{ env.STACK_NAME }}_backend --filter "desired-state=running" --format "{{.Error}}" | grep -v "^$" || true)
          FRONTEND_ERRORS=$(docker service ps ${{ env.STACK_NAME }}_frontend --filter "desired-state=running" --format "{{.Error}}" | grep -v "^$" || true)
          
          if [ -n "$BACKEND_ERRORS" ] || [ -n "$FRONTEND_ERRORS" ]; then
            echo "‚ùå Errors detected during deployment!"
            exit 1
          fi

          echo "üéâ Deploy completed successfully with zero downtime!"
