name: Pipeline CI/CD

on:
  push:
    branches:
      - main

env:
  DEPLOY_HOST: 10.10.1.222
  DEPLOY_USER: root
  DEPLOY_PORT: 22
  PROJECT_DIR: /home/admin-ti/controle_material
  DOCKER_REGISTRY: 10.10.1.222:5000
  MYSQL_DATABASE: controle_material
  STACK_NAME: controle_estoque

jobs:
  build:
    name: Build and Push Images
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build backend image
        run: |
          docker build -t ${{ env.DOCKER_REGISTRY }}/controle_material-backend:latest \
                       -t ${{ env.DOCKER_REGISTRY }}/controle_material-backend:${{ github.sha }} \
                       ./backend
          docker save -o backend-image.tar \
                      ${{ env.DOCKER_REGISTRY }}/controle_material-backend:latest \
                      ${{ env.DOCKER_REGISTRY }}/controle_material-backend:${{ github.sha }}

      - name: Build frontend image
        run: |
          docker build -t ${{ env.DOCKER_REGISTRY }}/controle_material-frontend:latest \
                       -t ${{ env.DOCKER_REGISTRY }}/controle_material-frontend:${{ github.sha }} \
                       ./frontend
          docker save -o frontend-image.tar \
                      ${{ env.DOCKER_REGISTRY }}/controle_material-frontend:latest \
                      ${{ env.DOCKER_REGISTRY }}/controle_material-frontend:${{ github.sha }}

      - name: Upload backend image artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-image
          path: backend-image.tar
          retention-days: 1

      - name: Upload frontend image artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-image
          path: frontend-image.tar
          retention-days: 1

  deploy:
    name: Deploy to Swarm
    needs: build
    runs-on: self-hosted  # Runner no mesmo servidor do Swarm
    steps:
      - name: Download backend image
        uses: actions/download-artifact@v4
        with:
          name: backend-image

      - name: Download frontend image
        uses: actions/download-artifact@v4
        with:
          name: frontend-image

      - name: Deploy Locally
        env:
          DOCKER_REGISTRY: ${{ env.DOCKER_REGISTRY }}
          STACK_NAME: ${{ env.STACK_NAME }}
        run: |
          echo "üì¶ Loading backend image..."
          docker load -i backend-image.tar

          echo "üì¶ Loading frontend image..."
          docker load -i frontend-image.tar

          echo "üöÄ Pushing to local registry..."
          docker push ${{ env.DOCKER_REGISTRY }}/controle_material-backend:latest
          docker push ${{ env.DOCKER_REGISTRY }}/controle_material-backend:${{ github.sha }}
          docker push ${{ env.DOCKER_REGISTRY }}/controle_material-frontend:latest
          docker push ${{ env.DOCKER_REGISTRY }}/controle_material-frontend:${{ github.sha }}

          echo "üßπ Cleaning up tar files..."
          rm -f backend-image.tar frontend-image.tar

          echo "üîÑ Updating Swarm services..."
          docker service update --image ${{ env.DOCKER_REGISTRY }}/controle_material-backend:latest ${{ env.STACK_NAME }}_backend
          docker service update --image ${{ env.DOCKER_REGISTRY }}/controle_material-frontend:latest ${{ env.STACK_NAME }}_frontend

          echo "‚è≥ Waiting for rollout..."
          sleep 10

          echo "‚úÖ Service status:"
          docker service ls | grep ${{ env.STACK_NAME }}
          echo ""
          echo "Backend replicas:"
          docker service ps ${{ env.STACK_NAME }}_backend --format "table {{.Name}}\t{{.CurrentState}}\t{{.Error}}" | head -n 3
          echo ""
          echo "Frontend replicas:"
          docker service ps ${{ env.STACK_NAME }}_frontend --format "table {{.Name}}\t{{.CurrentState}}\t{{.Error}}" | head -n 3

          echo "üéâ Deploy completed successfully!"
